name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build and Test
    uses: ./.github/workflows/build.yml
    permissions:                    
      actions: read
      contents: read
      security-events: write
    with:
      node-version: '20.x'
      postgres-version: '15-alpine'
      docker-image-name: 'fullstack-app'

  Tivy-scan:
    name: Trivy Scan
    needs: build-and-test
    uses: ./.github/workflows/trivy-scan.yml
    permissions:                   
      
      security-events: write
    with:
      docker-image-name: 'fullstack-app'
      scan-severity: 'HIGH,CRITICAL'
      ignore-unfixed: true
      fail-on-severity: false
  
  zizmor-scan:
        name: Zizmor Scan
        needs: build-and-test
        uses: ./.github/workflows/zizmor-scan.yml
        permissions:
          contents: read
          security-events: write
        with:
          zizmor-version: '0.10.0'
          workflow-paths: '.github/workflows/'