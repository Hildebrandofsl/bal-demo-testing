name: Zizmor Security Scan

on:
  workflow_call:
    inputs:
      zizmor-version:
        description: 'Version of Zizmor to use'
        required: false
        type: string
        default: 'v1.16.2'
      workflow-paths:
        description: 'Path to workflows directory'
        required: false
        type: string
        default: '.github/workflows/'

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download and Install Zizmor
        env:
          VERSION: ${{ inputs.zizmor-version }}
        run: |
          curl -sSL "https://github.com/zizmorcore/zizmor/releases/download/${VERSION}/zizmor-x86_64-unknown-linux-gnu.tar.gz" -o zizmor.tar.gz
          tar -xzf zizmor.tar.gz
          chmod +x zizmor
          sudo mv zizmor /usr/local/bin/
          zizmor --version
      
      - name: Run Zizmor Scan
        run: |
          zizmor --format sarif ${{ inputs.workflow-paths }} > zizmor-results.sarif
        continue-on-error: true
        
      - name: Verify SARIF file exists
        run: |
          if [ -f zizmor-results.sarif ]; then
            echo "âœ… SARIF file created successfully"
            echo "File size: $(wc -c < zizmor-results.sarif) bytes"
            jq -r '.runs[].results[] | "[\(.level)] \(.message.text)"' zizmor-results.sarif || true
          else
            echo "âŒ SARIF file not found!"
            ls -la
            exit 1
          fi
        
      - name: Upload SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: zizmor-results.sarif
          category: zizmor
          
      - name: Check for Error-level findings
        if: always()
        run: |
          if [ -f zizmor-results.sarif ]; then
            errors=$(jq '[.runs[].results[] | select(.level=="error")] | length' zizmor-results.sarif)
            echo "Found $errors 'Error'-level findings."
            
            if [ "$errors" -gt 0 ]; then
              echo "::error::âŒ Zizmor detected $errors critical workflow vulnerability(ies)."
              echo "ðŸ”— View results: https://github.com/${{ github.repository }}/security/code-scanning?query=tool:zizmor"
              exit 1
            else
              echo "âœ… No 'Error'-level issues found by Zizmor."
            fi
          fi