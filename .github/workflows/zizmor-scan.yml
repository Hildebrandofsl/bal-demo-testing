name: Zizmor Security Scan

on:
  workflow_call:
    inputs:
      workflow-paths:
        description: 'Paths to workflow files to scan'
        required: false
        type: string
        default: '.github/workflows/'

permissions:
  contents: read
  security-events: write

jobs:
  zizmor-scan:
    name: Scan GitHub Actions Workflows
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # üß© Run Zizmor scan (stable release)
      - name: Run Zizmor scan
        id: zizmor
        continue-on-error: true
        uses: zizmorcore/zizmor-action@v0.2.0
        with:
          inputs: ${{ inputs.workflow-paths }}
          advanced-security: true  # Auto-upload SARIF to GitHub Code Scanning
          annotations: false

      # üß† Fail only if Zizmor reports "Error"-level findings
      - name: Fail job if 'Error' findings are detected
        if: always()
        run: |
          echo "üîç Checking for Zizmor 'Error'-level findings..."

          # Use the SARIF file if available
          if [ -f zizmor-results.sarif ]; then
            errors=$(jq '[.runs[].results[] | select(.level=="error")] | length' zizmor-results.sarif)
          else
            # Zizmor auto-uploads results when advanced-security=true, so no local file may exist
            errors=0
          fi

          echo "Found $errors 'Error'-level findings."
          if [ "$errors" -gt 0 ] || [ "${{ steps.zizmor.outcome }}" != "success" ]; then
            echo "::error::‚ùå Zizmor detected $errors critical workflow vulnerability(ies)."
            echo ""
            echo "üîó View detailed results in GitHub Code Scanning:"
            echo "üëâ https://github.com/${{ github.repository }}/security/code-scanning?query=tool:zizmor+severity:error"
            exit 1
          else
            echo "‚úÖ No 'Error'-level issues found by Zizmor."
          fi