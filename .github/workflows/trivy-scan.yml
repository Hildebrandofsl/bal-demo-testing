name: Trivy Security Scan

on:
  workflow_call:
    inputs:
      docker-image-name:
        description: 'Docker image name to scan'
        required: false
        type: string
        default: 'app'
      scan-severity:
        description: 'Severity levels to scan for'
        required: false
        type: string
        default: 'HIGH,CRITICAL'
      fail-on-severity:
        description: 'Fail workflow if vulnerabilities found'
        required: false
        type: boolean
        default: true

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: Load Docker image
        run: gunzip -c docker-image.tar.gz | docker load

      - name: Install Trivy
        run: |
            if ! command -v trivy &> /dev/null; then
              TRIVY_VERSION="0.66.0"
              wget -qO- https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz | tar xz -C /tmp
              sudo mv /tmp/trivy /usr/local/bin/trivy
            fi

      - name: Update Trivy vulnerability database
        run: |
          echo "üì¶ Refreshing Trivy vulnerability database..."
          trivy image --download-db-only alpine:3.19 || true

      - name: Run Trivy scans (fs, image, config)
        env:
          DOCKER_IMAGE: ${{ inputs.docker-image-name }}
          DOCKER_TAG: ${{ github.sha }}
          SEVERITY: ${{ inputs.scan-severity }}
        id: trivy-scan
        run: |
          mkdir -p trivy-results
          SEVERITY=${SEVERITY}

          echo "üîç Scanning filesystem dependencies..."
          trivy fs \
            --scanners vuln \
            --format sarif \
            --output trivy-results/fs.sarif \
            --severity $SEVERITY \
            --ignore-unfixed \
            --exit-code 1 \
            --quiet . || echo "fs-scan-failed=true" >> $GITHUB_ENV

          echo "üê≥ Scanning Docker image..."
          trivy image \
            --format sarif \
            --output trivy-results/image.sarif \
            --severity $SEVERITY \
            --ignore-unfixed \
            --exit-code 1 \
            --quiet ${DOCKER_TAG}:${DOCKER_TAG} || echo "image-scan-failed=true" >> $GITHUB_ENV

          echo "üß± Scanning IaC/Dockerfile..."
          trivy config \
            --format sarif \
            --output trivy-results/config.sarif \
            --severity $SEVERITY \
            --exit-code 1 \
            --quiet . || echo "config-scan-failed=true" >> $GITHUB_ENV

      - name: Upload filesystem scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results/fs.sarif
          category: trivy-fs
          wait-for-processing: true

      - name: Upload image scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results/image.sarif
          category: trivy-image
          wait-for-processing: true

      - name: Upload config scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results/config.sarif
          category: trivy-config
          wait-for-processing: true

      - name: Fail workflow if vulnerabilities found
        if: always()
        run: |
          REPO_URL="https://github.com/${{ github.repository }}/security/code-scanning"
      
          echo "üîç Checking Trivy scan results..."
          if [[ "${{ env.fs-scan-failed }}" == "true" || \
                "${{ env.image-scan-failed }}" == "true" || \
                "${{ env.config-scan-failed }}" == "true" ]]; then
            echo ""
            echo "--------------------------------------------"
            echo "‚ùå One or more Trivy scans detected vulnerabilities!"
            echo "üîó Check details here: ${REPO_URL}"
            echo "--------------------------------------------"
            exit 1
          else
            echo "::notice::‚úÖ No critical or high vulnerabilities found."
            echo ""
            echo "--------------------------------------------"
            echo "‚úÖ No critical or high vulnerabilities found."
            echo "üîó View security dashboard: ${REPO_URL}"
            echo "--------------------------------------------"
          fi
      